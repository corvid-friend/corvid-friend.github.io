<!-- Improved Font Debug Tool -->
<div style="position: fixed; bottom: 10px; right: 10px; background: yellow; padding: 15px; z-index: 9999; font-size: 14px; border: 2px solid black; max-width: 350px; box-shadow: 3px 3px 5px rgba(0,0,0,0.2);" id="font-debug">
  üîç Font debugger loading...
</div>

<script>
  function getActualFont(element) {
    element.offsetHeight; // Force reflow
    return window.getComputedStyle(element).fontFamily;
  }

  // Better font detection that actually checks if Noto is rendering
  function isNotoRendering() {
    // Create two test elements with the same text
    const testDiv = document.createElement('div');
    testDiv.style.position = 'absolute';
    testDiv.style.left = '-9999px';
    testDiv.style.top = '-9999px';
    testDiv.style.fontSize = '100px'; // Large size to emphasize differences
    testDiv.style.whiteSpace = 'nowrap';
    testDiv.innerHTML = 'Áõ¥ Êó•Êú¨Ë™û „ÉÜ„Çπ„Éà';
    
    // Clone for Noto test
    const notoDiv = testDiv.cloneNode(true);
    notoDiv.style.fontFamily = '"Noto Serif JP", serif';
    
    // Clone for fallback test (use a very different font)
    const monoDiv = testDiv.cloneNode(true);
    monoDiv.style.fontFamily = 'monospace';
    
    // Add to document
    document.body.appendChild(notoDiv);
    document.body.appendChild(monoDiv);
    
    // Measure widths
    const notoWidth = notoDiv.offsetWidth;
    const monoWidth = monoDiv.offsetWidth;
    
    // Clean up
    document.body.removeChild(notoDiv);
    document.body.removeChild(monoDiv);
    
    // Log values for debugging
    console.log('Noto width:', notoWidth, 'Mono width:', monoWidth);
    
    // If Noto is loaded, width should be DIFFERENT from monospace
    // If Noto failed to load, it would fall back to serif which might be closer to monospace
    const widthDifference = Math.abs(notoWidth - monoWidth);
    
    // More lenient threshold - if width difference is significant, Noto is likely loaded
    return widthDifference > 10;
  }

  // Check if the font file actually loaded via Network API
  function checkFontResource() {
    if (window.performance && window.performance.getEntries) {
      const resources = window.performance.getEntries();
      const fontFiles = resources.filter(r => 
        r.name.includes('NotoSerifJP') || 
        r.name.includes('noto-serif-jp')
      );
      
      if (fontFiles.length > 0) {
        return {
          loaded: true,
          files: fontFiles.map(f => f.name.split('/').pop())
        };
      }
    }
    return { loaded: false, files: [] };
  }

  setTimeout(function() {
    const debugDiv = document.getElementById('font-debug');
    const bodyFont = getActualFont(document.body);
    const sampleElement = document.querySelector('p') || document.body;
    const sampleFont = getActualFont(sampleElement);
    
    // Multiple detection methods
    const renderingTest = isNotoRendering();
    const resourceCheck = checkFontResource();
    
    // Check what's in the computed style
    const computedStyles = window.getComputedStyle(document.body);
    const activeFont = computedStyles.fontFamily;
    
    // Determine if Noto is actually working
    let notoStatus = '‚ùå NO';
    let statusReason = '';
    
    if (resourceCheck.loaded) {
      notoStatus = '‚úÖ YES (font file loaded)';
    } else if (renderingTest) {
      notoStatus = '‚úÖ YES (rendering test passed)';
    } else if (activeFont.includes('Noto Serif JP') && !activeFont.includes('-apple-system')) {
      notoStatus = '‚ö†Ô∏è MAYBE (checking)';
    }
    
    // List all fonts on the page
    const allElements = document.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, a, span, div');
    let fontsUsed = new Set();
    allElements.forEach(el => {
      try {
        const font = window.getComputedStyle(el).fontFamily.split(',')[0].replace(/['"]/g, '').trim();
        if (font && font.length > 0) {
          fontsUsed.add(font);
        }
      } catch(e) {}
    });
    
    // Visual test - create a sample with explicit Noto font
    const sampleSpan = document.createElement('span');
    sampleSpan.style.fontFamily = '"Noto Serif JP", serif';
    sampleSpan.style.fontSize = '16px';
    sampleSpan.style.padding = '2px 5px';
    sampleSpan.style.backgroundColor = '#e0e0e0';
    sampleSpan.style.display = 'inline-block';
    sampleSpan.style.marginTop = '5px';
    sampleSpan.textContent = 'Áõ¥ (explicit Noto)';
    
    // Add to debug div
    debugDiv.innerHTML = '';
    debugDiv.style.backgroundColor = '#fff9c4';
    
    const content = `
      <strong>üîç Font Debug Info:</strong><br>
      <hr style="margin: 5px 0;">
      <span style="color: ${notoStatus.includes('YES') ? 'green' : 'red'}; font-weight: bold;">
        Noto loaded: ${notoStatus}
      </span><br>
      <small>${resourceCheck.files.length ? 'Files: ' + resourceCheck.files.join(', ') : ''}</small><br>
      Body font: ${bodyFont.substring(0, 40)}...<br>
      Sample font: ${sampleFont.substring(0, 40)}...<br>
      Active fonts: ${Array.from(fontsUsed).slice(0, 3).join(', ')}${fontsUsed.size > 3 ? '...' : ''}<br>
      <hr style="margin: 5px 0;">
      <div style="background: white; padding: 5px; border: 1px solid #ccc;">
        <strong>Visual Test:</strong><br>
        <span style="font-family: 'Noto Serif JP', serif;">Áõ¥ (Noto explicit)</span><br>
        <span>Áõ¥ (current body)</span><br>
        <span style="font-family: monospace;">Áõ¥ (monospace)</span>
      </div>
    `;
    
    debugDiv.innerHTML = content;
    
    // Log detailed info to console
    console.log('=== FONT DEBUG INFO ===');
    console.log('Resource check:', resourceCheck);
    console.log('Rendering test:', renderingTest);
    console.log('Body font:', bodyFont);
    console.log('All fonts detected:', Array.from(fontsUsed));
    
  }, 2000);
</script>
